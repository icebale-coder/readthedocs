title: BGP

# Протокол BGP
Disclaimer:
```bash
Является на сегодняшний день единственным в природе 
EGP (External Gateway Protocol) протоколом маршутизации.
Занесен в "красную книгу" Интернета...

Берегите BGP!!! )))
```

## Определение/Назначение

Предназначен для передачи маршрутной информации как внутри AS **iBGP**, так и между AS **eBGP**.
"Де-факто", является единственным протокол динамической маршрутизации в сети Internet.

## Установление соединения
Соединение устанавливается по **tcp на порту 179**
Изначально любой сосед может инициироавть соединение если это в явном виде не запрещено в настройках.


## Таймеры протокола
Keepalive Interval — Интервал времени в секундах, между отправкой сообщений keepalive. По умолчанию 60 секунд.
Hold Time — Интервал времени в секундах, по истечении которого сосед будет считаться недоступным. По умолчанию 180 секунд.


## Формат протокола

Всё бессовестно содрано [отсюда](http://admindoc.ru/category/settings_cisco/bgp-cisco_books/) и [отсюда](http://xgu.ru/wiki/BGP) - но лаконичнее этого сказать сложно!!! )))


## Типы сообщений в BGP

Тип сообщения передается в заголовке вида:
```bash
|<-------------------------- 32 бита --------------------------->|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                                                               |
+                                                               +
|                           Marker                              |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Length               |      Type     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

Marker — поле, которое включено в заголовок для совместимости. Размер поля — 16 байт, все байты должны быть 1.
Length — длина всего сообщения в октетах, включая заголовок. Поле может принимать значения от 19 до 4096.

Type — тип передаваемого сообщения:

— 1 OPEN - используется для установки отношений соседства и обмена базовыми параметрами. Отправляется сразу после установки TCP-соединения.
— 2 UPDATE - используется для обмена информацией о префиксах.
— 3 NOTIFICATION - используется когда возникают ошибки BGP. После отправки сообщения сессия с соседом разрывается.
— 4 KEEPALIVE - используется для проверки доступности соседа.


### OPEN - формат сообщения

```bash
|<-------------------------- 32 бита --------------------------->|
+-+-+-+-+-+-+-+-+
|    Version    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     My Autonomous System      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Hold Time           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         BGP Identifier                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Opt Parm Len  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                       Optional Parameters                     |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

2 — UPDATE
3 — NOTIFICATION
4 — KEEPALIVE

## Состояния связи с соседями

- Idle - изначальное состояние, в которое переходит BGP как только создается создается сосед в конфиге.
- Connect - BGP ожидает TCP соединение
- Active -  Инициализация TCP соединения, если соединение не установлено, то состояние переходит в режим Connect. 
            После нескольких попыток переходит инициализации переходит в состояние Idle.
- Open sent - BGP ожидает OPEN сообщения, после получения такого сообщения, проверяются все обязательные атрибуты, 
             если что-то не соответствует, то посылается сообщение NOTIFICATION сообщение с указанием ошибки.
             Если все ок, BGP начинает посылать сообщение KEEPALIVE. Если таймеры keepalive установлены у пиров разные, 
             то устанавливается минимальное значение. 
             Если на этой стадии обнаружен разрыв TCP сессии, роутер переходит в состояние Active.
- Open confirm - после согласования таймеров keepalive на данной стадии дожидаемся прихода этого сообщения, 
            если оно пришло, все ок, мы переходим к следующей стадии. 
- Established - означает, что соединение установлено, таймеры согласованы и  начинается обмен маршрутами.

## Настройки

- [Базовая фильтрация + установка атрибутов](https://icebale.readthedocs.io/en/latest/networks/protocols/BGP/Settings/PMTUD)
- [ORF](https://icebale.readthedocs.io/en/latest/networks/protocols/BGP/Settings/ORF) 
- [Soft-reconfiguration](https://icebale.readthedocs.io/en/latest/networks/protocols/BGP/Settings/Soft-reconfiguration)
- [PMTUD](https://icebale.readthedocs.io/en/latest/networks/protocols/BGP/Settings/PMTUD)
- [Fall-over](https://icebale.readthedocs.io/en/latest/networks/protocols/BGP/Settings/Fall-over)
- [BGP PIC](https://icebale.readthedocs.io/en/latest/networks/protocols/BGP/Settings/BGP-PIC)



## Литература
[1. BGP: Установление сессии между пирами](http://admindoc.ru/1153/session-peers/)
[2. BGP](http://xgu.ru/wiki/BGP)